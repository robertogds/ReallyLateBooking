// Generated by CoffeeScript 1.3.3
(function() {

  root.loadUser = function() {
    Ti.API.info('Entra en loadUser');
    if (Titanium.App.Properties.hasProperty("user")) {
      Ti.API.info('Tiene user');
      root.user = JSON.parse(Titanium.App.Properties.getString("user"));
      return root.fetchCreditsAsync();
    } else if (Titanium.Facebook.loggedIn) {
      Ti.API.info('Esta logado con facebook');
      if (Titanium.App.Properties.hasProperty("facebookUser")) {
        root.facebookUser = JSON.parse(Titanium.App.Properties.getString("facebookUser"));
        Ti.API.info('FACEBOOK EMAIL = ' + root.facebookUser.email);
        root.user = root.facebookUser;
        Ti.API.info('USEREMAIL = ' + root.user.email);
        root.user.id = root.facebookUser.rlbId;
        root.user.token = root.facebookUser.rlbToken;
        root.user.secret = root.facebookUser.rlbSecret;
        root.user.password = root.facebookUser.rlbPassword;
        root.user.firstName = root.facebookUser.first_name;
        root.user.lastName = root.facebookUser.last_name;
        return root.fetchCreditsAsync();
      } else {
        Ti.API.info('Esta logado con facebook pero no tenemos datos, hacemos logout');
        Titanium.Facebook.logout();
        return root.creditsTab.badge = '+5';
      }
    } else {
      Ti.API.info('No tiene ni user ni esta logado con facebook, borramos todo');
      Titanium.App.Properties.removeProperty("user");
      Titanium.App.Properties.removeProperty("facebookUser");
      return root.creditsTab.badge = '+5';
    }
  };

  root.loadRefererId = function() {
    Ti.API.info('*** Entra en refererId');
    if (root.user.refererId === null || root.user.refererId === void 0 || root.user.refererId.length < 2) {
      Ti.API.info('*** El refererId es null');
      return root.fetchServerUser();
    }
  };

  root.urlSignature = function(url) {
    var timestamp, token;
    timestamp = new Date().getTime();
    token = root.user.token;
    return url + '/' + token + '/' + timestamp;
  };

  root.doSignature = function(url) {
    var secret;
    secret = root.user.secret;
    return Titanium.Utils.md5HexDigest(url + secret);
  };

  root.isLogged = function(e) {
    Ti.API.info('Entra en isLogged');
    if (Titanium.App.Properties.hasProperty("user")) {
      Ti.API.info('isLogged TRUE');
      return true;
    } else if (Titanium.App.Properties.hasProperty("facebookUser")) {
      Ti.API.info('isLogged TRUE - FACEBOOK');
      return true;
    } else {
      Ti.API.info('isLogged FALSE');
    }
    return false;
  };

}).call(this);
