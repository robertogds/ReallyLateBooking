// Generated by CoffeeScript 1.3.3
(function() {

  root.xhrBookings = Titanium.Network.createHTTPClient({
    timeout: 15000
  });

  root.xhrBookings.onload = function() {
    root.bookingsWindow.remove(root.errorView);
    root.bookingsLastUpdate = new Date();
    root.bookings = JSON.parse(this.responseText);
    return root.populateBookingsTable(root.bookings);
  };

  root.xhrBookings.onerror = function() {
    Ti.UI.createAlertDialog({
      title: 'ReallyLateBooking',
      message: L('errorHappened')
    }).show();
    root.hideLoading(root.bookingsWindow);
    return root.showError(root.bookingsWindow);
  };

  root.xhrBookings.timedout = function() {
    return Ti.UI.createAlertDialog({
      title: 'ReallyLateBooking',
      message: L('errorHappened')
    }).show();
  };

  root.fetchBookingsConnect = function() {
    var signature, url;
    Ti.API.info('FetchBookins es necesario actualizar');
    root.noBookingsView.hide();
    root.showLoading(root.bookingsWindow);
    url = root.urlSignature('/user/' + root.user.id + '/bookings');
    signature = root.doSignature(url);
    url = url + '/' + signature;
    root.xhrBookings.open('GET', root.url + url);
    root.xhrBookings.setRequestHeader("Accept-Language", Titanium.Locale.currentLanguage);
    return root.xhrBookings.send();
  };

  root.showBookings = function() {
    var diffTime, now;
    Ti.API.info('Entra en showBookings');
    now = new Date();
    diffTime = now.getTime() - root.bookingsLastUpdate.getTime();
    Ti.API.info('FetchBookings -- La diferencia es ' + diffTime);
    if (root.bookings === void 0 || diffTime > 100000) {
      return root.fetchBookingsConnect();
    } else {
      Ti.API.info('FetchBookins NO es necesario actualizar');
      return root.populateBookingsTable(root.bookings);
    }
  };

}).call(this);
