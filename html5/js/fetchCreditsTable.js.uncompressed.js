// Generated by CoffeeScript 1.3.3
(function() {

  root.xhrCredits = Titanium.Network.createHTTPClient({
    timeout: 15000
  });

  root.xhrCredits.onload = function() {
    Ti.API.info('Entra en load credits OK' + this.responseText);
    root.creditsLastUpdate = new Date();
    root.listCreditsWindow.remove(root.errorView);
    Ti.API.info(this.responseText);
    root.credits = JSON.parse(this.responseText);
    Ti.API.info(this.responseText);
    root.creditsTable.footerView = root.footerView;
    root.hideLoading(root.listCreditsWindow);
    return root.populateCreditsTable(root.credits);
  };

  root.xhrCredits.onerror = function() {
    Ti.UI.createAlertDialog({
      title: 'ReallyLateBooking',
      message: L('errorHappened')
    }).show();
    return root.hideLoading(root.listCreditsWindow);
  };

  root.showCreditsConnect = function() {
    var signature, url;
    root.showLoading(root.listCreditsWindow);
    url = root.urlSignature('/user/' + root.user.id + '/coupons');
    signature = root.doSignature(url);
    url = url + '/' + signature;
    root.xhrCredits.open('GET', root.url + url);
    root.xhrCredits.setRequestHeader("Accept-Language", Titanium.Locale.currentLanguage);
    return root.xhrCredits.send();
  };

  root.showCredits = function() {
    var diffTime, now;
    Ti.API.info('Entra en showCredits');
    now = new Date();
    diffTime = now.getTime() - root.creditsLastUpdate.getTime();
    Ti.API.info('FetchCreditsTable -- La diferencia es ' + diffTime);
    if (root.credits === void 0 || diffTime > 100000) {
      return root.showCreditsConnect();
    } else {
      Ti.API.info('FetchCreditsTable NO es necesario actualizar');
      return root.populateCreditsTable(root.credits);
    }
  };

}).call(this);
