define(["./declare","./lang"],function(h,f){var g=require.is,e=h("Ti._.Promise",null,{constructor:function(a){this._canceller=a},resolve:function(a){this._complete(a,0)},reject:function(a){this._complete(a,1)},then:function(a,c){var b={resolved:a,error:c,promise:new e(this.cancel)};this._nextListener?this._head=this._head.next=b:this._nextListener=this._head=b;this._finished&&this._notify(this._fired);return b.returnPromise},cancel:function(){if(!this._finished){var a=this._canceller&&this._canceller(this);
this._finished||(a instanceof Error||(a=Error(a)),a.log=!1,this.reject(a))}},_fired:-1,_complete:function(a,c){this._fired=c;if(this._finished)throw Error("This promise has already been resolved");this._result=a;this._finished=!0;this._notify(c)},_notify:function(a){for(var c,b,d;this._nextListener;)if(b=this._nextListener,this._nextListener=this._nextListener.next,c=b[a?"error":"resolved"])try{(d=c(this._result))&&g(d.then,"Function")?d.then(f.hitch(b.promise,"resolve"),f.hitch(b.promise,"reject")):
b.promise.resolve(d)}catch(e){b.promise.reject(e)}else b.promise[a?"reject":"resolve"](result)}});e.when=function(a,c,b,d){return a&&g(a.then,"function")?a.then(c,b,d):c?c(a):a};return e});