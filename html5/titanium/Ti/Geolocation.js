define(["Ti/_/Evented","Ti/_/lang","Ti/Network"],function(j,m){function n(a){var b=o(window,"deviceorientation",function(c){b();a(c)})}function p(a){return function(b){d={heading:{accuracy:b.webkitCompassAccuracy,magneticHeading:b.webkitCompassHeading},success:!0,timestamp:(new Date).getTime()};c.fireEvent("heading",d);a&&a(d)}}function i(a){return function(b){var e="coords"in b;f={success:e};e?f.coords=b.coords:f.code=b.code;c.fireEvent("location",f);a&&a(f)}}function q(){return{enableHighAccuracy:c.accuracy===
c.ACCURACY_HIGH,timeout:c.MobileWeb.locationTimeout,maximumAge:c.MobileWeb.maximumLocationAge}}var c,o=require.on,g=!1,d,r,s,f,h=0,k=0,l=m.isDef;n(function(a){l(a.webkitCompassHeading)&&(g=!0)});return c=m.setObject("Ti.Geolocation",j,{getCurrentPosition:function(a){c.locationServicesEnabled&&navigator.geolocation.getCurrentPosition(i(a),i(a),q())},getCurrentHeading:function(a){g&&(d&&(new Date).getTime()-d.timestamp<c.maximumHeadingAge?a(d):n(p(a)))},forwardGeocoder:function(a,b){if(require.is(a,
"String")){var e=Ti.Network.createHTTPClient({onload:function(){var a=this.responseText.split(",");b({success:!0,places:[{latitude:parseFloat(a[2]),longitude:parseFloat(a[3])}]})},onerror:function(){b({success:!1})},timeout:c.MobileWeb.forwardGeocoderTimeout});e.open("GET","http://api.appcelerator.net/p/v1/geo?d=f&q="+escape(a));e.send()}},reverseGeocoder:function(a,b,e){if(l(a)&&l(b)){var d=Ti.Network.createHTTPClient({onload:function(){e(JSON.parse(this.responseText))},onerror:function(){e({success:!1})},
timeout:c.MobileWeb.forwardGeocoderTimeout});d.open("GET","http://api.appcelerator.net/p/v1/geo?d=r&q="+a+","+b);d.send()}},addEventListener:function(a,b){switch(a){case "heading":g&&(h++,1===h&&(r=o(window,"deviceorientation",p())));break;case "location":c.locationServicesEnabled&&(k++,1===k&&(s=navigator.geolocation.watchPosition(i(),i(),q())))}j.addEventListener.call(this,a,b)},removeEventListener:function(a,b){switch(a){case "heading":g&&(h--,0===h&&r());break;case "location":c.locationServicesEnabled&&
(k--,1>h&&navigator.geolocation.clearWatch(s))}j.removeEventListener.call(this,a,b)},constants:{ACCURACY_HIGH:1,ACCURACY_LOW:2,ERROR_DENIED:1,ERROR_LOCATION_UNKNOWN:2,ERROR_TIMEOUT:3,locationServicesEnabled:{get:function(){return!!navigator.geolocation}},MobileWeb:{locationTimeout:Infinity,maximumLocationAge:0,maximumHeadingAge:1E3,forwardGeocoderTimeout:void 0,reverseGeocoderTimeout:void 0},hasCompass:function(){return g}},properties:{accuracy:2}})});