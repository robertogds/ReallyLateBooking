// Generated by CoffeeScript 1.3.3
(function() {

  root.xhrValidateCoupon = Titanium.Network.createHTTPClient({
    timeout: 15000
  });

  root.xhrValidateCoupon.onload = function(e) {
    var response;
    Ti.API.info(this.responseText);
    Ti.API.info('_____________________ COUPON VALIDADO CON EXITO ********************');
    root.hideLoading(root.creditsWindow);
    try {
      response = JSON.parse(this.responseText);
    } catch (error) {
      Ti.UI.createAlertDialog({
        title: 'ReallyLateBooking',
        message: L('errorBooking')
      }).show();
    }
    Ti.API.info(response);
    if (response.status === 201) {
      return root.fetchCreditsConnect();
    } else {
      Ti.API.error('error de compra');
      return Ti.UI.createAlertDialog({
        title: 'ReallyLateBooking',
        message: 'Error: ' + response.detail
      }).show();
    }
  };

  root.xhrValidateCoupon.onerror = function(e) {
    root.hideLoading(root.creditsWindow);
    root.showError();
    return Ti.API.error(e);
  };

  root.validateCoupon = function(code) {
    var newCoupon, signature, url, user;
    Ti.API.info('_____________________ ENTRA EN VALIDAR COUPON ********************');
    url = root.urlSignature('/coupon');
    signature = root.doSignature(url);
    url = url + '/' + signature;
    root.xhrValidateCoupon.open("POST", root.surl + url);
    root.xhrValidateCoupon.setRequestHeader("Content-Type", "application/json; charset=utf-8");
    root.xhrValidateCoupon.setRequestHeader("Accept-Language", Titanium.Locale.currentLanguage);
    user = {};
    user.id = root.user.id;
    newCoupon = JSON.stringify({
      "user": user,
      "key": code
    });
    Ti.API.info(newCoupon);
    Ti.API.info('Paso pre-compra');
    root.xhrValidateCoupon.send(newCoupon);
    return Ti.API.info('Paso post-compra');
  };

}).call(this);
